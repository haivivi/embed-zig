# AEC Test - ESP Platform
# Tests microphone with AEC (Acoustic Echo Cancellation)

load("//bazel/esp:defs.bzl", "esp_flash", "esp_zig_app")
load("//bazel/zig:defs.bzl", "zig_module")

package(default_visibility = ["//visibility:public"])

filegroup(
    name = "srcs",
    srcs = [
        "//examples/apps/aec_test:app_srcs",
    ] + glob(["**/*"]),
)

zig_module(name = "idf", main = "//lib/platform/esp/idf:src/idf.zig", srcs = ["//lib/platform/esp/idf:zig_srcs"], c_srcs = ["//lib/platform/esp/idf:c_srcs"], link_libc = True)
zig_module(name = "impl", main = "//lib/platform/esp/impl:src/impl.zig", srcs = ["//lib/platform/esp/impl:zig_srcs"], deps = [":idf", "//lib/trait", "//lib/hal", "//lib/pkg/drivers", "//lib/pkg/math", "//lib/pkg/motion", "//lib/pkg/waitgroup", "//lib/pkg/channel", "//lib/pkg/cancellation"])
zig_module(name = "esp", main = "//lib/platform/esp:src/esp.zig", srcs = ["//lib/platform/esp:all_zig_srcs"], deps = [":idf", ":impl", "//lib/trait", "//lib/hal", "//lib/pkg/drivers", "//lib/pkg/math", "//lib/pkg/motion"])

esp_zig_app(
    name = "app",
    app = ":srcs",
    boards = ["korvo2_v3", "lichuang_szp", "lichuang_gocool"],
    requires = [
        "driver",
        "esp_driver_i2s",
        "esp_driver_gpio",
        "esp_driver_i2c",
        "nvs_flash",
        "esp_wifi",
        "lwip",
    ],
    force_link = [
        "${I2S_FORCE_LINK}",
        "${I2C_FORCE_LINK}",
        "${SR_FORCE_LINK}",
        "${RUNTIME_FORCE_LINK}",
        "${WIFI_FORCE_LINK}",
    ],
    extra_cmake = [
        "include(${_ESP_LIB}/platform/esp/idf/src/i2s/i2s.cmake)",
        "include(${_ESP_LIB}/platform/esp/idf/src/i2c/i2c.cmake)",
        "include(${_ESP_LIB}/platform/esp/idf/src/sr/sr.cmake)",
        "include(${_ESP_LIB}/platform/esp/idf/src/runtime/runtime.cmake)",
        "include(${_ESP_LIB}/platform/esp/idf/src/wifi/wifi.cmake)",
    ],
    extra_c_sources = ["I2S_C_SOURCES", "I2C_C_SOURCES", "SR_C_SOURCES", "RUNTIME_C_SOURCES", "WIFI_C_SOURCES"],
    deps = [":idf", ":esp",

 "//lib/hal", "//lib/trait", "//lib/pkg/drivers", "//lib/pkg/motion", "//lib/pkg/math"],
    idf_deps = [
        "espressif/esp-sr:^2.1.1",
    ],
    sdkconfig = "//examples/esp:esp32s3_sr",
    app_config = "//examples/esp:app_internal",
)

esp_flash(
    name = "flash",
    app = ":app",
)
