load("//bazel/bk:defs.bzl", "bk_flash", "bk_modules", "bk_monitor", "bk_zig_app")
load("//bazel/bk/kconfig:defs.bzl", "bk_config")
load("//bazel/bk/kconfig:crypto.bzl", "bk_crypto")
load("//bazel/bk/partition:entry.bzl", "bk_partition_entry")
load("//bazel/bk/partition:table.bzl", "bk_partition_table")
load("//bazel/zig:defs.bzl", "zig_static_library")

package(default_visibility = ["//visibility:public"])

filegroup(
    name = "srcs",
    srcs = ["//examples/apps/opus_test:app_srcs"] + glob(["**/*"]),
)

# Cross-compile opus for ARM Cortex-M33 (FIXED_POINT)
# Uses Armino GCC's newlib headers via sysroot_path_setting
zig_static_library(
    name = "opus_arm",
    lib = "//third_party/opus:opus_fixed",
    target = "thumb-freestanding-eabihf",
    cpu = "cortex_m33",
    optimize = "ReleaseSmall",
    sysroot_path_setting = "//bazel:armino_path",
    sysroot_subdir = "gcc-arm-none-eabi-10.3-2021.10/arm-none-eabi/include",
)

# PSRAM needed for opus encoder/decoder state
bk_crypto(name = "crypto")
bk_config(name = "kconfig", modules = [":crypto"])

# Partition table (larger AP partition for opus binary)
bk_partition_entry(name = "part_bootloader", partition_name = "primary_bootloader", type = "code", partition_size = "68K")
bk_partition_entry(name = "part_cp", partition_name = "primary_cp_app", type = "code", partition_size = "1360K")
bk_partition_entry(name = "part_ap", partition_name = "primary_ap_app", type = "code", partition_size = "1564K")
bk_partition_entry(name = "part_ota", partition_name = "ota", type = "data", partition_size = "1020K", write = True)
bk_partition_entry(name = "part_usr_config", partition_name = "usr_config", type = "data", partition_size = "60K", write = True)
bk_partition_entry(name = "part_easyflash", partition_name = "easyflash", type = "data", partition_size = "8K", offset = "0x7fa000", write = True)
bk_partition_entry(name = "part_easyflash_ap", partition_name = "easyflash_ap", type = "data", partition_size = "8K", offset = "0x7fc000", write = True)
bk_partition_entry(name = "part_sys_rf", partition_name = "sys_rf", type = "data", partition_size = "4K", offset = "0x7fe000", write = True)
bk_partition_entry(name = "part_sys_net", partition_name = "sys_net", type = "data", partition_size = "4K", offset = "0x7ff000", write = True)

bk_partition_table(
    name = "partitions",
    entries = [":part_bootloader", ":part_cp", ":part_ap", ":part_ota", ":part_usr_config",
               ":part_easyflash", ":part_easyflash_ap", ":part_sys_rf", ":part_sys_net"],
)

bk_modules()

bk_zig_app(
    name = "app",
    ap = ":srcs",
    cp = "//lib/platform/bk/cp:base",
    deps = [":bk", "//lib/hal", "//lib/trait", "//third_party/opus:opus_fixed"],
    partition_table = ":partitions",
    kconfig_ap = ":kconfig",
    run_in_psram = 131072,  # 128KB PSRAM stack (opus needs ~30KB)
    static_libs = [":opus_arm"],
    c_helpers = [
        "//lib/platform/bk/armino:c_helpers_core",
        "//lib/platform/bk/armino:c_helpers_heap",
    ],
)

bk_flash(name = "flash", app = ":app")
bk_monitor(name = "monitor")
