load("//bazel:env.bzl", "make_env_file")
load("//bazel/bk:defs.bzl", "bk_flash", "bk_modules", "bk_monitor", "bk_zig_app")
load("//bazel/bk/kconfig:defs.bzl", "bk_config")
load("//bazel/bk/kconfig:crypto.bzl", "bk_crypto")
load("//bazel/bk/kconfig:lwip.bzl", "bk_lwip_fast")
load("//bazel/bk/partition:entry.bzl", "bk_partition_entry")
load("//bazel/bk/partition:table.bzl", "bk_partition_table")

package(default_visibility = ["//visibility:public"])

filegroup(
    name = "srcs",
    srcs = ["//examples/apps/tls_speed_test:app_srcs"] + glob(["**/*"]),
)

make_env_file(
    name = "env",
    defines = ["WIFI_SSID", "WIFI_PASSWORD", "TEST_SERVER", "TLS_PORT"],
    defaults = {"TLS_PORT": "8443"},
)

bk_crypto(name = "crypto")
bk_lwip_fast(name = "lwip_fast")
bk_config(name = "kconfig", modules = [":crypto", ":lwip_fast"])

# Partition table (BK7258, 8MB flash â€” all offsets explicit)
bk_partition_entry(name = "part_bootloader", partition_name = "primary_bootloader", type = "code", partition_size = "68K")
bk_partition_entry(name = "part_cp", partition_name = "primary_cp_app", type = "code", partition_size = "1360K")
bk_partition_entry(name = "part_ap", partition_name = "primary_ap_app", type = "code", partition_size = "1156K")
bk_partition_entry(name = "part_ota", partition_name = "ota", type = "data", partition_size = "1428K", write = True)
bk_partition_entry(name = "part_usr_config", partition_name = "usr_config", type = "data", partition_size = "60K", write = True)
bk_partition_entry(name = "part_easyflash", partition_name = "easyflash", type = "data", partition_size = "8K", offset = "0x7fa000", write = True)
bk_partition_entry(name = "part_easyflash_ap", partition_name = "easyflash_ap", type = "data", partition_size = "8K", offset = "0x7fc000", write = True)
bk_partition_entry(name = "part_sys_rf", partition_name = "sys_rf", type = "data", partition_size = "4K", offset = "0x7fe000", write = True)
bk_partition_entry(name = "part_sys_net", partition_name = "sys_net", type = "data", partition_size = "4K", offset = "0x7ff000", write = True)

bk_partition_table(
    name = "partitions",
    entries = [":part_bootloader", ":part_cp", ":part_ap", ":part_ota", ":part_usr_config",
               ":part_easyflash", ":part_easyflash_ap", ":part_sys_rf", ":part_sys_net"],
)

bk_modules()

bk_zig_app(
    name = "app",
    ap = ":srcs",
    cp = "//lib/platform/bk/cp:base",
    deps = [":bk", "//lib/hal", "//lib/trait", "//lib/pkg/tls"],
    env = ":env",
    partition_table = ":partitions",
    kconfig_ap = ":kconfig",
    ap_stack_size = 65536,  # 64KB for TLS
    c_helpers = [
        "//lib/platform/bk/armino:c_helpers_core",
        "//lib/platform/bk/armino:c_helpers_wifi",
        "//lib/platform/bk/armino:c_helpers_socket",
        "//lib/platform/bk/armino:c_helpers_crypto",
        "//lib/platform/bk/armino:c_helpers_heap",
    ],
)

bk_flash(name = "flash", app = ":app")
bk_monitor(name = "monitor")
