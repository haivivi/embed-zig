# mqtt0 Integration Tests
#
# Test coverage:
#   - Zig client ↔ Zig broker (MQTT 3.1.1 + 5.0)
#   - Zig client → Go broker (cross-language)
#   - Go client → Zig broker (cross-language)

load("@rules_shell//shell:sh_test.bzl", "sh_test")

package(default_visibility = ["//visibility:public"])

# ============================================================================
# Zig Self-Test (zig client ↔ zig broker, v4 + v5)
# ============================================================================

sh_test(
    name = "mqtt0_zig_test",
    srcs = ["zig_test.sh"],
    data = [
        "//lib/pkg/mqtt0:mqtt0",
        "//lib/trait:trait",
    ],
    env = {
        "ZIG_GLOBAL_CACHE_DIR": "/tmp/zig-cache",
    },
    tags = [
        "integration",
        "local",
        "no-sandbox",
    ],
    timeout = "moderate",
)

# ============================================================================
# Cross-Language Test (requires Go)
# ============================================================================

sh_test(
    name = "mqtt0_cross_test",
    srcs = ["cross_test.sh"],
    data = [
        "//lib/pkg/mqtt0:mqtt0",
        "//lib/trait:trait",
        "//tools/mqtt_server:srcs",
        "//tools/mqtt_client:srcs",
    ],
    env = {
        "ZIG_GLOBAL_CACHE_DIR": "/tmp/zig-cache",
    },
    tags = [
        "integration",
        "requires-network",
        "local",
        "no-sandbox",
    ],
    timeout = "moderate",
)

# ============================================================================
# Source files
# ============================================================================

filegroup(
    name = "test_sources",
    srcs = glob(["*.sh"]),
)
