# TLS Integration Tests
#
# Run tests with Bazel:
#   bazel test //lib/pkg/net/tls/test:tls_test           # Full integration test
#   bazel run //lib/pkg/net/tls/test:tls_test_server    # Run server manually
#
# Test coverage:
#   - TLS 1.2, TLS 1.3
#   - AES-128-GCM, AES-256-GCM, ChaCha20-Poly1305
#   - RSA-2048, ECDSA P-256, ECDSA P-384
#   - X25519, P-256, P-384 curves
#   - SNI, ALPN extensions
#   - Large data transfer (1MB)

load("@rules_go//go:def.bzl", "go_binary")
load("@rules_shell//shell:sh_binary.bzl", "sh_binary")
load("@rules_shell//shell:sh_test.bzl", "sh_test")

package(default_visibility = ["//visibility:public"])

# ============================================================================
# Go TLS Test Server
# ============================================================================

go_binary(
    name = "tls_test_server",
    srcs = ["server/main.go"],
    visibility = ["//visibility:public"],
)

# ============================================================================
# Integration Test
# ============================================================================

sh_test(
    name = "tls_test",
    srcs = ["bazel_test.sh"],
    data = [
        ":server_sources",
        "//lib/pkg/net/tls:srcs",
        "//lib/pkg/crypto:srcs",
        "//lib/trait:srcs",
    ],
    env = {
        "ZIG_GLOBAL_CACHE_DIR": "/tmp/zig-cache",
    },
    tags = [
        "integration",
        "requires-network",
        "local",
        "no-sandbox",  # Need network access
    ],
    timeout = "moderate",
)

# ============================================================================
# Unit Test Only (no server)
# ============================================================================

sh_test(
    name = "tls_unit_test",
    srcs = ["bazel_unit_test.sh"],
    data = [
        "//lib/pkg/net/tls:srcs",
        "//lib/pkg/crypto:srcs",
        "//lib/trait:srcs",
        "@zig_toolchain//:zig_files",
    ],
    env = {
        "ZIG_GLOBAL_CACHE_DIR": "/tmp/zig-cache",
    },
    tags = ["unit"],
    timeout = "short",
)

# ============================================================================
# Helper: Run server standalone
# ============================================================================

sh_binary(
    name = "run_server",
    srcs = ["run_server_bazel.sh"],
    data = [":tls_test_server"],
)

# ============================================================================
# Source files
# ============================================================================

filegroup(
    name = "test_sources",
    srcs = glob(["*.zig", "*.sh"]),
)

filegroup(
    name = "server_sources", 
    srcs = glob(["server/**"]),
)
