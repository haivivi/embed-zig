"""Zig bindings for libopus.

External projects must setup the @opus repository in their MODULE.bazel:

    bazel_dep(name = "embed_zig", version = "...")
    
    opus_ext = use_extension("@embed_zig//third_party/opus:repository.bzl", "opus_repository")
    use_repo(opus_ext, "opus")

Or in WORKSPACE:

    load("@embed_zig//third_party/opus:repository.bzl", "opus_repository")
    opus_repository(name = "opus")

Then depend on:
- //third_party/opus:opus_fixed (for embedded/Xtensa, FIXED_POINT)
- //third_party/opus:opus_float (for desktop/server, better quality)
"""

load("//bazel/zig:defs.bzl", "zig_library")

package(default_visibility = ["//visibility:public"])

# Common args shared by both variants
_COMMON_C_FLAGS = ["-DOPUS_BUILD", "-DHAVE_LRINTF", "-DVAR_ARRAYS"]

# Opus compiled with FIXED_POINT — no float, fast on Xtensa/embedded
zig_library(
    name = "opus_fixed",
    main = "opus.zig",
    srcs = ["opus.zig"],
    c_srcs = [
        "@opus//:core_srcs",
        "@opus//:fixed_srcs",
        "@opus//:headers",
    ],
    c_flags = _COMMON_C_FLAGS + ["-DFIXED_POINT"],
    link_libc = True,
    module_name = "opus",
)

# Opus compiled with float SILK — better quality, needs FPU
zig_library(
    name = "opus_float",
    main = "opus.zig",
    srcs = ["opus.zig"],
    c_srcs = [
        "@opus//:core_srcs",
        "@opus//:float_srcs",
        "@opus//:headers",
    ],
    c_flags = _COMMON_C_FLAGS,
    link_libc = True,
    module_name = "opus",
)

filegroup(name = "srcs", srcs = glob(["**/*"]))
